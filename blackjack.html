<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Play Blackjack</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="poker-body">

    <nav class="navbar">
        <div class="logo">Queen of Hearts Casino</div>
        <div class="user-controls">
            <span class="credits-badge">Balance: $<span id="balance-display">Loading...</span></span>
            <button id="username-btn" class="user-badge" onclick="window.location.href='/account'">Guest</button>
            <button class="logout-btn" onclick="window.location.href='/dashboard'">Exit</button>
        </div>
    </nav>

    <div class="blackjack-table">
        <div id="game-message" class="message-overlay">You Win!</div>

        <div class="player-section">
            <div class="section-label">Your Hand <span id="player-score">(0)</span></div>
            <div id="player-cards" class="hand-container">
                <div class="card-slot card-hidden"></div>
                <div class="card-slot card-hidden"></div>
            </div>
        </div>

        <div style="text-align: center; color: #d4af37; font-weight: bold; text-shadow: 1px 1px black;">
            <p>BLACKJACK PAYS 3 TO 2</p>
            <p>DEALER STANDS ON 17</p>
        </div>

        <div class="house-section">
            <div class="section-label">The House <span id="house-score">(?)</span></div>
            <div id="house-cards" class="hand-container">
                <div class="card-slot card-hidden"></div>
                <div class="card-slot card-hidden"></div>
            </div>
        </div>

        <div class="game-actions-bj">
            <button class="poker-btn btn-hit" id="btn-hit" onclick="hit()" disabled>HIT</button>
            <button class="poker-btn btn-stand" id="btn-stand" onclick="stand()" disabled>STAND</button>
        </div>

        <div style="position: absolute; bottom: 20px;">
            <div class="controls-bar">
                <span style="color: #ffd700; font-weight: bold;">Bet: $</span>
                <input type="number" id="bet-input" class="bet-input" value="10">
                <button class="poker-btn btn-deal" onclick="startCustomGame()">DEAL</button>
                <button class="poker-btn btn-deal" id="btn-rebet" onclick="rebet()" style="display:none; background-color: gold; color: black;">REBET</button>
            </div>
        </div>
    </div>

    <script>
        const suits = ['♥', '♦', '♣', '♠'];
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        let deck = [], playerHand = [], houseHand = [];
        let currentBet = 0, lastBet = 0, balance = 0, gameOver = true;
        
        const user = localStorage.getItem('username') || 'Guest';
        document.getElementById('username-btn').innerText = user;

        fetchUserBalance();

        async function fetchUserBalance() {
            if(user === 'Guest') return;
            try {
                const res = await fetch('/my-stats', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username: user}) });
                const data = await res.json();
                if(data.success) { balance = data.credits; document.getElementById('balance-display').innerText = balance; }
            } catch(e){}
        }

        function createDeck() {
            deck = [];
            for(let s of suits) {
                for(let r of ranks) {
                    let val = (['J','Q','K'].includes(r)) ? 10 : (r === 'A' ? 11 : parseInt(r));
                    deck.push({ rank: r, suit: s, value: val, color: (s === '♥' || s === '♦') ? 'card-red' : 'card-black' });
                }
            }
            deck.sort(() => Math.random() - 0.5);
        }

        function draw() { return deck.pop(); }

        function startCustomGame() {
            const val = parseInt(document.getElementById('bet-input').value);
            if (!val || val <= 0) return alert("Enter valid bet");
            startGame(val);
        }
        function rebet() { if(lastBet > 0) startGame(lastBet); }

        function startGame(amount) {
            if (balance < amount) return alert("Not enough funds");
            currentBet = amount; lastBet = amount;
            balance -= amount;
            gameOver = false;
            
            updateServerStats(amount, 0);
            createDeck();
            playerHand = [draw(), draw()];
            houseHand = [draw(), draw()];
            
            document.getElementById('game-message').style.display = 'none';
            document.getElementById('btn-rebet').style.display = 'none';
            document.getElementById('house-score').innerText = "(?)";
            
            toggleControls(true);
            renderTable(false);

            if (calculateScore(playerHand) === 21) setTimeout(() => handleBlackjack(), 500);
        }

        function hit() {
            if(gameOver) return;
            playerHand.push(draw());
            renderTable(false);
            if(calculateScore(playerHand) > 21) endGame("BUST!", 0);
        }

        function stand() {
            if(gameOver) return;
            let ds = calculateScore(houseHand);
            while(ds < 17) { houseHand.push(draw()); ds = calculateScore(houseHand); }
            renderTable(true);
            
            const ps = calculateScore(playerHand);
            if(ds > 21) endGame("Dealer Busts! You Win", currentBet * 2);
            else if(ps > ds) endGame("You Win!", currentBet * 2);
            else if(ds > ps) endGame("House Wins", 0);
            else endGame("Push", currentBet);
        }

        function handleBlackjack() {
            renderTable(true);
            if(calculateScore(houseHand) === 21) endGame("Push", currentBet);
            else endGame("BLACKJACK!", currentBet * 2.5);
        }

        function endGame(msg, payout) {
            gameOver = true;
            toggleControls(false);
            document.getElementById('game-message').innerText = msg;
            document.getElementById('game-message').style.display = 'block';
            if(payout > 0) updateServerStats(0, payout);
            document.getElementById('btn-rebet').style.display = 'inline-block';
        }

        function calculateScore(hand) {
            let s = 0, a = 0;
            hand.forEach(c => { s += c.value; if(c.rank === 'A') a++; });
            while(s > 21 && a > 0) { s -= 10; a--; }
            return s;
        }

        function renderTable(showHouse) {
            document.getElementById('player-cards').innerHTML = playerHand.map(createCardHTML).join('');
            document.getElementById('player-score').innerText = `(${calculateScore(playerHand)})`;
            
            const hDiv = document.getElementById('house-cards');
            hDiv.innerHTML = '';
            houseHand.forEach((c, i) => {
                if(i===0 && !showHouse) hDiv.innerHTML += `<div class="card-slot card-hidden"></div>`;
                else hDiv.innerHTML += createCardHTML(c);
            });
            if(showHouse) document.getElementById('house-score').innerText = `(${calculateScore(houseHand)})`;
        }

        function createCardHTML(c) {
            return `<div class="card-slot ${c.color}"><div>${c.rank}</div><div class="card-center-suit">${c.suit}</div><div style="transform: rotate(180deg); text-align: right;">${c.rank}</div></div>`;
        }

        function toggleControls(active) {
            document.getElementById('btn-hit').disabled = !active;
            document.getElementById('btn-stand').disabled = !active;
        }

        async function updateServerStats(bet, win) {
            try {
                const res = await fetch('/game-result', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username: user, betAmount: bet, winAmount: win})});
                const d = await res.json();
                if(d.success) { balance = d.credits; document.getElementById('balance-display').innerText = balance; }
            } catch(e){}
        }
    </script>
</body>
</html>