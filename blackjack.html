<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Play Blackjack</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- CSS SAFETY BLOCK --- */
        .bet-input {
            width: 100px;
            padding: 10px;
            border-radius: 5px;
            border: none;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .rebet-btn {
            background-color: #ffd700;
            color: black;
            border: 2px solid #d4af37;
        }
        /* Ensure card backs are visible */
        .card-hidden {
            background: repeating-linear-gradient(
                45deg,
                #606dbc,
                #606dbc 10px,
                #465298 10px,
                #465298 20px
            );
            color: transparent !important;
            border: 2px solid #fff;
        }
        /* Basic card shape if style.css fails */
        .card-slot {
            min-width: 60px;
            min-height: 90px;
            background-color: white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid #333;
        }
        .card-red { color: red; border-color: red; }
        .card-black { color: black; border-color: black; }
    </style>
</head>
<body class="poker-body">

    <nav class="navbar">
        <div class="logo">Queen of Hearts Casino</div>
        <div class="user-controls">
            <span class="credits-badge">Bet: $<span id="current-bet">0</span></span>
            <span class="credits-badge">Balance: $<span id="balance-display">Loading...</span></span>
            <button id="username-btn" class="user-badge" onclick="window.location.href='/account'">Guest</button>
            <button class="logout-btn" onclick="window.location.href='/dashboard'">Exit</button>
        </div>
    </nav>

    <div class="poker-table">
        <div id="bj-popup" class="bj-popup">BLACKJACK!</div>
        <div id="game-message" class="message-overlay">You Win!</div>

        <div class="player-section">
            <div class="section-label">Your Hand <span id="player-score">(0)</span></div>
            <div style="display: flex; gap: 10px;" id="player-cards">
                <div class="card-slot card-hidden"></div>
                <div class="card-slot card-hidden"></div>
            </div>
        </div>

        <div class="blackjack-center-rules">
            <p>☆ Blackjack pays 3 to 2 ☆</p>
            <p>☆ Dealer stands on 17 ☆</p>
        </div>

        <div class="house-section">
            <div class="section-label">The House <span id="house-score">(?)</span></div>
            <div style="display: flex; gap: 10px;" id="house-cards">
                <div class="card-slot card-hidden"></div>
                <div class="card-slot card-hidden"></div>
            </div>
        </div>

        <div class="betting-controls" id="bet-controls">
            <input type="number" id="bet-input" class="bet-input" placeholder="Amount" value="10">
            
            <button class="bet-btn" style="width: auto; border-radius: 10px; padding: 0 15px;" onclick="startCustomGame()">
                Deal Hand
            </button>
            
            <button id="btn-rebet" class="bet-btn rebet-btn" style="width: auto; border-radius: 10px; padding: 0 15px; display: none;" onclick="rebet()">
                Rebet & Deal
            </button>
        </div>

        <div class="game-actions">
            <button class="poker-btn btn-hit" id="btn-hit" onclick="hit()" disabled>HIT</button>
            <button class="poker-btn btn-stand" id="btn-stand" onclick="stand()" disabled>STAND</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const suits = ['♥', '♦', '♣', '♠'];
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        
        let deck = [], playerHand = [], houseHand = [];
        let currentBet = 0, lastBet = 0;
        
        // Initial Local Load
        let balance = parseInt(localStorage.getItem('credits')) || 0;
        const user = localStorage.getItem('username') || 'Guest';
        let gameOver = true;

        document.getElementById('username-btn').innerText = user;

        // FETCH REAL BALANCE IMMEDIATELY
        fetchUserBalance();

        async function fetchUserBalance() {
            if (user === 'Guest') return;
            try {
                const response = await fetch('/my-stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user })
                });
                const data = await response.json();
                if (data.success) {
                    balance = data.credits;
                    document.getElementById('balance-display').innerText = balance;
                    localStorage.setItem('credits', balance);
                }
            } catch (e) { console.error("Sync error", e); }
        }

        function createDeck() {
            deck = [];
            for(let s of suits) {
                for(let r of ranks) {
                    let val = (['J','Q','K'].includes(r)) ? 10 : (r === 'A' ? 11 : parseInt(r));
                    deck.push({ rank: r, suit: s, value: val, color: (s === '♥' || s === '♦') ? 'card-red' : 'card-black' });
                }
            }
            deck.sort(() => Math.random() - 0.5);
        }

        function draw() { return deck.pop(); }

        // --- GAME LOGIC ---
        function startCustomGame() {
            const val = parseInt(document.getElementById('bet-input').value);
            if (!val || val <= 0) return alert("Enter a valid amount");
            startGame(val);
        }

        function rebet() {
            if (lastBet > 0) startGame(lastBet);
        }

        function startGame(amount) {
            if (balance < amount) return alert("Not enough credits!");

            currentBet = amount;
            lastBet = amount;
            document.getElementById('btn-rebet').style.display = 'none';

            balance -= amount;
            gameOver = false;
            createDeck();
            
            updateServerStats(amount, 0); // Deduct bet immediately

            playerHand = [draw(), draw()];
            houseHand = [draw(), draw()];
            
            // UI Reset
            document.getElementById('game-message').style.display = 'none';
            document.getElementById('bj-popup').classList.remove('show');
            document.getElementById('current-bet').innerText = currentBet;
            document.getElementById('house-score').innerText = "(?)"; // Reset House Score to hidden
            
            toggleControls(true);
            renderTable(false); // False = Hide Dealer Card

            if (calculateScore(playerHand) === 21) setTimeout(() => handleBlackjack(), 500);
        }

        function hit() {
            if (gameOver) return;
            playerHand.push(draw());
            renderTable(false);
            if (calculateScore(playerHand) > 21) endGame("Bust! House Wins.");
        }

        function stand() {
            if (gameOver) return;
            let dScore = calculateScore(houseHand);
            while (dScore < 17) {
                houseHand.push(draw());
                dScore = calculateScore(houseHand);
            }
            renderTable(true); // True = Reveal Dealer
            determineWinner();
        }

        function handleBlackjack() {
            if (calculateScore(houseHand) === 21) {
                renderTable(true);
                endGame("Push (Tie)", currentBet);
            } else {
                renderTable(true);
                const win = currentBet + (currentBet * 1.5);
                document.getElementById('bj-popup').classList.add('show');
                setTimeout(() => {
                    document.getElementById('bj-popup').classList.remove('show');
                    endGame("BLACKJACK! Pays 3:2", win);
                }, 2000);
            }
        }

        function determineWinner() {
            const pScore = calculateScore(playerHand);
            const dScore = calculateScore(houseHand);

            if (dScore > 21) endGame("Dealer Busts! You Win.", currentBet * 2);
            else if (pScore > dScore) endGame("You Win!", currentBet * 2);
            else if (dScore > pScore) endGame("House Wins.");
            else endGame("Push.", currentBet);
        }

        function endGame(msg, payout = 0) {
            gameOver = true;
            toggleControls(false);
            
            const msgEl = document.getElementById('game-message');
            msgEl.innerText = msg;
            msgEl.style.display = 'block';
            msgEl.style.color = payout > currentBet ? '#ffd700' : (payout === currentBet ? 'white' : '#ff4444');

            if (payout > 0) updateServerStats(0, payout);
            
            const rebetBtn = document.getElementById('btn-rebet');
            rebetBtn.style.display = 'inline-block';
            rebetBtn.innerText = `Rebet ($${lastBet})`;
        }

        function calculateScore(hand) {
            let score = 0, aces = 0;
            hand.forEach(c => { score += c.value; if (c.rank === 'A') aces++; });
            while (score > 21 && aces > 0) { score -= 10; aces--; }
            return score;
        }

        // --- SERVER SYNC ---
        async function updateServerStats(bet, win) {
            const username = localStorage.getItem('username');
            try {
                const res = await fetch('/game-result', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username, betAmount: bet, winAmount: win})
                });
                const data = await res.json();
                if(data.success) { 
                    balance = data.credits; 
                    document.getElementById('balance-display').innerText = balance;
                    localStorage.setItem('credits', balance);
                }
            } catch(e){}
        }

        function createCardHTML(card) {
            return `<div class="card-slot ${card.color}"><div>${card.rank}</div><div class="card-center-suit">${card.suit}</div><div style="transform: rotate(180deg); text-align: right;">${card.rank}</div></div>`;
        }

        // --- UPDATED RENDER FUNCTION ---
        function renderTable(revealDealer) {
            // Render Player
            document.getElementById('player-cards').innerHTML = playerHand.map(createCardHTML).join('');
            document.getElementById('player-score').innerText = `(${calculateScore(playerHand)})`;

            // Render House
            const hDiv = document.getElementById('house-cards');
            hDiv.innerHTML = '';
            
            // Logic for showing House Score
            const houseScoreEl = document.getElementById('house-score');

            houseHand.forEach((c, i) => {
                if (i === 0 && !revealDealer) {
                    // Hide the first card
                    hDiv.innerHTML += `<div class="card-slot card-hidden"></div>`;
                    houseScoreEl.innerText = "(?)"; 
                } else {
                    hDiv.innerHTML += createCardHTML(c);
                }
            });

            // If revealed, show the total score
            if (revealDealer) {
                houseScoreEl.innerText = `(${calculateScore(houseHand)})`;
            }
        }

        function toggleControls(active) {
            document.getElementById('btn-hit').disabled = !active;
            document.getElementById('btn-stand').disabled = !active;
            const ctrl = document.getElementById('bet-controls');
            ctrl.style.pointerEvents = active ? 'none' : 'auto';
            ctrl.style.opacity = active ? '0.5' : '1';
        }
    </script>
</body>
</html>