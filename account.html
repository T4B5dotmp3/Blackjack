<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Account</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="account-body">

    <nav class="navbar">
        <div class="logo">Queen of Hearts Casino</div>
        <div class="user-controls">
            <span class="user-badge" id="account-username">Guest</span>
            
            <button class="logout-btn" onclick="window.location.href='/dashboard'">Back to Dashboard</button>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="account-main-content">
        
        <div class="account-card">
            <h2>Withdraw</h2>
            <p>Cash out your credits</p>
            
            <input type="number" id="withdraw-amount" class="withdraw-input" placeholder="Amount">
            
            <div style="font-weight: bold; margin-bottom: 10px;">
                Balance: $<span id="current-balance">0</span>
            </div>

            <button onclick="withdraw()" class="action-btn">Withdraw</button>
        </div>

        <div class="account-card">
            <h2>Overview</h2>
            <p>*Net Earnings / Losses*</p>
            
            <div id="net-display" class="stat-big">$0</div>
            
            <p>Total Withdrawn: $<span id="withdrawn-display">0</span></p>
        </div>

    </div>

    <footer class="footer">Developed by T4B5</footer>

    <script>
        const username = localStorage.getItem('username');
        if (username) document.getElementById('account-username').innerText = username;

        // 1. Load Stats
        async function loadStats() {
            try {
                const response = await fetch('/my-stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('current-balance').innerText = data.credits;
                    document.getElementById('withdrawn-display').innerText = data.totalWithdrawn;
                    
                    const netElem = document.getElementById('net-display');
                    netElem.innerText = `$${data.netEarnings}`;
                    
                    // Color Logic: Green for positive, Red for negative
                    if (data.netEarnings > 0) netElem.style.color = "#4caf50"; 
                    else if (data.netEarnings < 0) netElem.style.color = "#ff9999"; 
                    else netElem.style.color = "white";
                }
            } catch (err) { console.error("Error loading stats"); }
        }

        // 2. Withdraw Logic
        async function withdraw() {
            const amount = document.getElementById('withdraw-amount').value;
            if (!amount || amount <= 0) return alert("Enter a valid amount");

            try {
                const response = await fetch('/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, amount })
                });
                const result = await response.json();

                if (result.success) {
                    alert(`Successfully withdrew $${amount}!`);
                    localStorage.setItem('credits', result.newBalance);
                    loadStats(); 
                    document.getElementById('withdraw-amount').value = "";
                } else {
                    alert(result.message || "Error withdrawing");
                }
            } catch (err) { alert("Server error"); }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }

        loadStats();
    </script>
</body>
</html>